# EDI 315 Mapping Configuration
# Config-driven field mapping from X12 JsonNode to CDB_EVENT table

ediType: EDI_315
description: "EDI 315 Status Details Mapping"
sourceFormat: X12
version: "1.0"

validations:
  # Note: ISA, GS, GE, IEA are envelope segments - not checked per transaction
  - rule: REQUIRED_SEGMENT
    segments: ["ST", "B4", "SE"]

  - rule: REQUIRED_FIELD
    fields: ["B4.03", "B4.07"]

targets:
  - table: CDB_EVENT
    type: DETAIL
    loopPath: R4
    description: "Container events from R4/DTM loops"
    fields:
      # From B4 segment (B4.03 = status code, B4.04 = date YYYYMMDD, B4.05 = time HHMM)
      - name: PRTNR_EVENT_CD
        source: "B4.03"
        type: STRING

      - name: EVENT_DATE
        source: "B4.04"
        type: DATETIME
        transform: CONCAT
        concatWith: "B4.05"
        format: "yyyyMMddHHmm"

      # Container Number: N9_EQ.02 first, else B4.07 + B4.08 + B4.13
      - name: CNTR_NO
        type: STRING
        transform: COALESCE
        sources:
          - source: "N9[01=EQ].02"
            transform: QUALIFIED_SEGMENT
          - concatFields: ["B4.07", "B4.08", "B4.13"]

      # MBL: N9_BM.02 or N9_BN.02 (with SCAC prefix for WHLC/EGLV/OOLU/PABV)
      - name: MBL_NO
        type: STRING
        transform: COALESCE
        sources:
          - source: "N9[01=BM].02"
            transform: QUALIFIED_SEGMENT
          - source: "N9[01=BN].02"
            transform: QUALIFIED_SEGMENT

      # From Q2 segment
      - name: VESSEL_CD
        source: "Q2.01"
        type: STRING

      - name: VOYAGE
        source: "Q2.09"
        type: STRING

      - name: VESSEL
        source: "Q2.13"
        type: STRING

      # From N9 segments (references)
      - name: BKG_NO
        source: "N9[01=BN].02"
        type: STRING
        transform: QUALIFIED_SEGMENT

      # PICKUP_NO: N9_PU.02 or N9_P8.02
      - name: PICKUP_NO
        type: STRING
        transform: COALESCE
        sources:
          - source: "N9[01=PU].02"
            transform: QUALIFIED_SEGMENT
          - source: "N9[01=P8].02"
            transform: QUALIFIED_SEGMENT

      - name: VGM_DATE
        source: "N9[01=VG].02"
        type: STRING
        transform: QUALIFIED_SEGMENT

      # IT_NO: N9_61.02, N9_IT.02, or N9_IB.02 (first non-empty)
      - name: IT_NO
        type: STRING
        transform: COALESCE
        sources:
          - source: "N9[01=61].02"
            transform: QUALIFIED_SEGMENT
          - source: "N9[01=IT].02"
            transform: QUALIFIED_SEGMENT
          - source: "N9[01=IB].02"
            transform: QUALIFIED_SEGMENT

      # LAST_FREE_DATE: N9_PU.03 or N9_LT.02
      - name: LAST_FREE_DATE
        type: STRING
        transform: COALESCE
        sources:
          - source: "N9[01=PU].03"
            transform: QUALIFIED_SEGMENT
          - source: "N9[01=LT].02"
            transform: QUALIFIED_SEGMENT

      # From R4 loop (event location)
      - name: EVENT_LOC
        source: "03"
        type: STRING

      - name: EVENT_LOC_NAME
        source: "04"
        type: STRING
        transform: TRIM_OR_NULL

      # SCAC lookup MUST come first (other lookups depend on it)
      - name: SCAC
        type: STRING
        transform: LOOKUP
        lookupTable: SCACCODE
        lookupKeyColumn: sender
        lookupKeyExpr: "${envelope.ISA.06}"
        lookupColumn: code

      # Lookups using SCAC (B4.03 is the partner event code)
      # Multi-column lookup: SCAC_CD + PRTNR_EVENT_CD + DATE_TYPE
      - name: ID
        type: INTEGER
        transform: LOOKUP
        lookupTable: OEVENTCODE
        lookupCondition: "SCAC_CD = '${scac}' AND PRTNR_EVENT_CD = '${PRTNR_EVENT_CD}' AND DATE_TYPE = 'A'"
        lookupColumn: EM2_EVENT_ID

      - name: EVENT_CODE
        type: STRING
        transform: LOOKUP
        lookupTable: OEVENTCODE
        lookupCondition: "SCAC_CD = '${scac}' AND PRTNR_EVENT_CD = '${PRTNR_EVENT_CD}' AND DATE_TYPE = 'A'"
        lookupColumn: OEC_EVENT_CD

      - name: EVENT_DESCP
        type: STRING
        transform: LOOKUP
        lookupTable: OEVENTCODE
        lookupCondition: "SCAC_CD = '${scac}' AND PRTNR_EVENT_CD = '${PRTNR_EVENT_CD}' AND DATE_TYPE = 'A'"
        lookupColumn: EVENT_DESC

      # From envelope
      - name: EDI_ISA_CTRL_NO
        source: "envelope.ISA.13"
        type: STRING

      - name: EDI_ST_TRX_NO
        source: "ST.02"
        type: STRING

      # From context
      - name: FILENAME
        source: "context.fileName"
        type: STRING

      # BOOKNO_FLAG: "" if N9_BM exists, "X" if only N9_BN exists
      - name: BOOKNO_FLAG
        type: STRING
        transform: BOOKNO_FLAG

      # ID_MAP_FLAG: From R4.01 - "D" if "1", "T" if "Y" or null, else R4.01
      - name: ID_MAP_FLAG
        source: "01"
        type: STRING
        transform: ID_MAP_FLAG

      # Constants
      - name: DATE_TYPE
        type: STRING
        transform: CONSTANT
        value: "A"

      - name: DATA_SOURCE
        type: STRING
        transform: CONSTANT
        value: "B2B"

      - name: STATUS
        type: STRING
        transform: CONSTANT
        value: "A"

      - name: UPDATE_USER
        type: STRING
        transform: CONSTANT
        value: "B2B"

      - name: SEND_FLAG
        type: STRING
        transform: CONSTANT
        value: ""

      - name: CREATE_DATE
        type: TIMESTAMP
        transform: CURRENT_TIMESTAMP

      - name: UPDATE_DATE
        type: TIMESTAMP
        transform: CURRENT_TIMESTAMP

# Partner-specific overrides
partnerOverrides:
  PARTNER_A:
    fieldOverrides:
      - name: DATE_TYPE
        transform: CONSTANT
        value: "E"

  PARTNER_B:
    fieldOverrides:
      - name: SCAC
        source: "B4.01"
        type: STRING
