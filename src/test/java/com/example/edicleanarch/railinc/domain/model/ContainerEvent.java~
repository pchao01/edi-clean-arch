package com.example.edicleanarch.railinc.domain.model;

import lombok.AccessLevel;
import lombok.AllArgsConstructor;

/**
 * Domain Entity: Railinc Container Event
 * Represents a container tracking event from Railinc CLM file.
 */
@AllArgsConstructor(access = AccessLevel.PRIVATE)
@Getter
public class ContainerEvent implements EdiEvent {

    private final ContainerEventId id;
    private final EquipmentId equipmentId;
    private final String billOfLading;
    private final EventInfo eventInfo;
    private final LocationInfo eventLocation;
    private final LocationInfo origin;
    private final LocationInfo destination;
    private final TransportInfo transportInfo;
    private final VesselInfo vesselInfo;
    private final String shipperCode;
    private String fileName;

    public static ContainerEvent withoutId(
            EquipmentId equipmentId,
            String billOfLading,
            EventInfo eventInfo,
            LocationInfo eventLocation,
            LocationInfo origin,
            LocationInfo destination,
            TransportInfo transportInfo,
            VesselInfo vesselInfo,
            String shipperCode) {
        return new ContainerEvent(
                null, equipmentId, billOfLading, eventInfo,
                eventLocation, origin, destination,
                transportInfo, vesselInfo, shipperCode, null);
    }

    public void setFileName(String fileName) {
        this.fileName = fileName;
    }

    public String getFullEquipmentId() {
        if (equipmentId == null) return null;
        return (equipmentId.initial() != null ? equipmentId.initial() : "") +
                (equipmentId.number() != null ? equipmentId.number() : "");
    }

    @Override
    public String getContainerNumber() {
        return getFullEquipmentId();
    }

    @Override
    public String getEventCode() {
        return eventInfo != null ? eventInfo.code() : null;
    }

    @Override
    public LocalDateTime getEventDateTime() {
        if (eventInfo == null || eventInfo.dateTime() == null) return null;
        try {
            return LocalDateTime.parse(eventInfo.dateTime(),
                    DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        } catch (DateTimeParseException e) {
            return null;
        }
    }

    @Override
    public String getEventLocation() {
        return eventLocation != null ? eventLocation.city() : null;
    }

    @Value
    public static class ContainerEventId {
        Long value;
    }

    public record EquipmentId(
            String initial,
            String number,
            String type
    ) {}

    public record EventInfo(
            String code,
            String dateTime,
            String etaDateTime
    ) {}

    public record LocationInfo(
            String city,
            String state,
            String splc
    ) {}

    public record TransportInfo(
            String loadEmptyStatus,
            String trainSymbol,
            String reportingRailroad,
            String interlineRailroad
    ) {}

    public record VesselInfo(
            String etaDateTime,
            String portOfLoad,
            String portOfDischarge
    ) {}
}
