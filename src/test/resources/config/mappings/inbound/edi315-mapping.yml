# EDI 315 Mapping Configuration
# Config-driven field mapping from X12 JsonNode to CDB_EVENT table

ediType: EDI_315
description: "EDI 315 Status Details Mapping"
sourceFormat: X12
version: "1.0"

validations:
  # Note: ISA, GS, GE, IEA are envelope segments - not checked per transaction
  - rule: REQUIRED_SEGMENT
    segments: ["ST", "B4", "SE"]

  - rule: REQUIRED_FIELD
    fields: ["B4.03", "B4.07"]

targets:
  - table: CDB_EVENT
    type: DETAIL
    loopPath: R4
    description: "Container events from R4/DTM loops"
    fields:
      # From B4 segment
      - name: EVENT_CODE
        source: "B4.02"
        type: STRING

      - name: EVENT_DATE
        type: DATETIME
        transform: BUILD_DATETIME
        sourceFields:
          century: "'20'"
          year: "B4.03"
          month: "B4.03"
          day: "B4.03"
          hour: "B4.04"
          minute: "B4.04"
        format: "yyyyMMddHHmm"

      # Container Number = B4.07 (prefix) + B4.08 (number) + B4.09 (check digit)
      - name: CNTR_NO
        type: STRING
        transform: CONCAT
        concatFields: ["B4.07", "B4.08", "B4.09"]

      # MBL from N9 segment with qualifier BM (Bill of Lading)
      - name: MBL_NO
        source: "N9[01=BM].02"
        type: STRING
        transform: QUALIFIED_SEGMENT

      # From Q2 segment
      - name: VESSEL_CD
        source: "Q2.01"
        type: STRING

      - name: VOYAGE
        source: "Q2.09"
        type: STRING

      - name: VESSEL
        source: "Q2.13"
        type: STRING

      # From N9 segments (booking number)
      - name: BKG_NO
        source: "N9[01=BN].02"
        type: STRING
        transform: QUALIFIED_SEGMENT

      # From R4 loop (event location)
      - name: EVENT_LOC
        source: "03"
        type: STRING

      - name: EVENT_LOC_NAME
        source: "04"
        type: STRING
        transform: TRIM_OR_NULL

      # Lookups
      - name: ID
        type: INTEGER
        transform: LOOKUP
        lookupTable: OEVENTCODE
        lookupKeyExpr: "${scac}_${B4.02}_A"
        lookupColumn: ID

      - name: EVENT_DESCP
        type: STRING
        transform: LOOKUP
        lookupTable: OEVENTCODE
        lookupKeyExpr: "${scac}_${B4.02}_A"
        lookupColumn: EVENT_DESCP

      # From envelope
      - name: EDI_ISA_CTRL_NO
        source: "envelope.ISA.13"
        type: STRING

      - name: EDI_ST_TRX_NO
        source: "ST.02"
        type: STRING

      - name: SCAC
        type: STRING
        transform: LOOKUP
        lookupTable: SCACCODE
        lookupKeyExpr: "${envelope.ISA.06}"
        lookupColumn: SCAC_CD

      # From context
      - name: FILENAME
        source: "context.fileName"
        type: STRING

      # Constants
      - name: DATE_TYPE
        type: STRING
        transform: CONSTANT
        value: "A"

      - name: DATA_SOURCE
        type: STRING
        transform: CONSTANT
        value: "EDI"

      - name: STATUS
        type: STRING
        transform: CONSTANT
        value: "A"

      - name: UPDATE_USER
        type: STRING
        transform: CONSTANT
        value: "B2B"

      - name: CREATE_DATE
        type: TIMESTAMP
        transform: CURRENT_TIMESTAMP

      - name: UPDATE_DATE
        type: TIMESTAMP
        transform: CURRENT_TIMESTAMP

# Partner-specific overrides
partnerOverrides:
  PARTNER_A:
    fieldOverrides:
      - name: DATE_TYPE
        transform: CONSTANT
        value: "E"

  PARTNER_B:
    fieldOverrides:
      - name: SCAC
        source: "B4.01"
        type: STRING
